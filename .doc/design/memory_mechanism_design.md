# Memory Mechanism Designï¼ˆè®°å¿†/å¾ªç¯æœºåˆ¶è®¾è®¡ï¼‰

> æœ¬æ–‡æ¡£é˜è¿° only_torch ä¸­è®°å¿†æœºåˆ¶ï¼ˆå¾ªç¯ç»“æ„ï¼‰çš„è®¾è®¡å†³ç­–ï¼ŒåŒ…æ‹¬ NEAT é£æ ¼å¾ªç¯ä¸ä¼ ç»Ÿ RNN å¾ªç¯çš„å…³ç³»ã€è®¾è®¡é€‰æ‹©åŠå®ç°è·¯å¾„ã€‚

---

## ğŸ“‹ å®ç°çŠ¶æ€é€Ÿè§ˆ

| Phase | çŠ¶æ€ | è¯´æ˜ |
|-------|------|------|
| Phase 1: åŸºç¡€å¾ªç¯ | âœ… | `step()`/`reset()`/`connect_recurrent()` |
| Phase 2: BPTT | âœ… | æ—¶é—´æ­¥å¿«ç…§ + æ¢¯åº¦ç´¯åŠ  |
| Phase 2.5: State èŠ‚ç‚¹ | âœ… | ä¿®å¤è·¨æ—¶é—´æ¢¯åº¦ä¼ é€’ |
| Phase 2 ä¿®å¤ A: é€šç”¨æ¿€æ´» | âœ… | æ”¯æŒ tanh/sigmoid/ä»»æ„ç»„åˆ |
| Phase 2 ä¿®å¤ B: VJP æ¨¡å¼ | âœ… | å¤§ batch/hidden é«˜æ•ˆè®­ç»ƒ |
| Phase 3: æ¨¡æ¿å±‚ | â³ | âˆ†-RNN, GRU, LSTM |
| Phase 4: NEAT é›†æˆ | â³ | ç»“æ„å˜å¼‚ã€ç‰©ç§å½¢æˆ |

**éªŒæ”¶æŒ‡æ ‡**ï¼š
- 7/7 PyTorch æ•°å€¼å¯¹ç…§æµ‹è¯•é€šè¿‡
- batch=64, hidden=256ï¼š241ms/5epochsï¼Œæ—  OOM
- IT-1 å¥‡å¶æ€§æ£€æµ‹ï¼š98% å‡†ç¡®ç‡

---

## 1. æ ¸å¿ƒæ¦‚å¿µè¾¨æ

### 1.1 ä¸¤ç§"å¾ªç¯"æ˜¯æ­£äº¤çš„

åœ¨æœºå™¨å­¦ä¹ ä¸­ï¼Œ"å¾ªç¯"ï¼ˆrecurrentï¼‰ä¸€è¯æœ‰ä¸¤ç§å®Œå…¨ä¸åŒçš„å«ä¹‰ï¼š

| æ¦‚å¿µ | NEAT å¾ªç¯ï¼ˆæ‹“æ‰‘å¾ªç¯ï¼‰ | ä¼ ç»Ÿ RNN å¾ªç¯ï¼ˆæ—¶é—´å±•å¼€ï¼‰ |
|------|----------------------|--------------------------|
| **å¾ªç¯å‘ç”Ÿåœ¨å“ª** | ç½‘ç»œ**æ‹“æ‰‘ç»“æ„**ä¸­ï¼ˆèŠ‚ç‚¹é—´å½¢æˆç¯ï¼‰ | **æ—¶é—´ç»´åº¦**ä¸Šï¼ˆåŒä¸€ç½‘ç»œé‡å¤æ‰§è¡Œï¼‰ |
| **æƒé‡å…±äº«** | âŒ æ¯ä¸ªè¿æ¥æœ‰ç‹¬ç«‹æƒé‡ | âœ… æ‰€æœ‰æ—¶é—´æ­¥å…±äº«åŒä¸€å¥—æƒé‡ |
| **çŠ¶æ€/è®°å¿†** | èŠ‚ç‚¹ä¿ç•™ä¸Šä¸€æ­¥è¾“å‡ºå€¼ï¼ˆåŒç¼“å†²ï¼‰ | éšè—çŠ¶æ€ h_t åœ¨æ—¶é—´æ­¥é—´ä¼ é€’ |
| **è®­ç»ƒæ–¹æ³•** | è¿›åŒ–ç®—æ³•ï¼ˆæ— æ¢¯åº¦ï¼‰ | BPTT / TBPTTï¼ˆæ¢¯åº¦ä¸‹é™ï¼‰ |
| **ç»“æ„** | å¯è¿›åŒ–ï¼ˆåŠ¨æ€æ‹“æ‰‘ï¼‰ | å›ºå®šï¼ˆLSTM/GRU é—¨æ§ç»“æ„ï¼‰ |

è¿™ä¸¤ç§æœºåˆ¶å¯ä»¥**ç‹¬ç«‹å­˜åœ¨**ï¼Œä¹Ÿå¯ä»¥**åŒæ—¶å­˜åœ¨**ï¼š

```
                    â”‚ æ— æ—¶é—´å±•å¼€           â”‚ æœ‰æ—¶é—´å±•å¼€ï¼ˆRNN é£æ ¼ï¼‰
 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 æ— æ‹“æ‰‘å¾ªç¯ï¼ˆDAGï¼‰   â”‚ å‰é¦ˆç½‘ç»œï¼ˆMLP, CNNï¼‰ â”‚ ä¼ ç»Ÿ RNN/LSTM/GRU
 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 æœ‰æ‹“æ‰‘å¾ªç¯         â”‚ NEAT Recurrent       â”‚ ä¸¤è€…ç»“åˆï¼ˆç½•è§ï¼‰
```

### 1.2 NEAT å¾ªç¯å¦‚ä½•å®ç°è®°å¿†

NEAT çš„å¾ªç¯ä¸æ˜¯"æ­»å¾ªç¯"ï¼Œè€Œæ˜¯åŸºäº**ç¦»æ•£æ—¶é—´æ­¥ + åŒç¼“å†²**ï¼š

```
æ¯æ¬¡ activate() è°ƒç”¨æ˜¯ä¸€ä¸ªæ—¶é—´æ­¥ï¼š
- è¯»å–ï¼šä¸Šä¸€æ­¥çš„èŠ‚ç‚¹è¾“å‡ºå€¼
- å†™å…¥ï¼šè¿™ä¸€æ­¥çš„èŠ‚ç‚¹è¾“å‡ºå€¼
- åˆ‡æ¢ï¼šåŒç¼“å†²äº¤æ›¿

èŠ‚ç‚¹ A çš„è‡ªè¿æ¥ï¼š
    t=0: A = f(input)           â†’ A_old = 0, A_new = 0.76
    t=1: A = f(input + A_old)   â†’ A_old = 0.76, A_new = 0.82
    t=2: A = f(input + A_old)   â†’ A_old = 0.82, A_new = 0.85
    ...
```

### 1.3 NEAT èƒ½å¦è¿›åŒ–å‡º RNN/LSTM/Transformerï¼Ÿ

| ç›®æ ‡ | èƒ½å¦è¿›åŒ– | è¯´æ˜ |
|------|---------|------|
| **è®°å¿†èƒ½åŠ›** | âœ… å¯ä»¥ | é€šè¿‡æ‹“æ‰‘å¾ªç¯ï¼ˆè‡ªè¿æ¥ï¼‰å®ç° |
| **RNN ç­‰ä»·åŠŸèƒ½** | âœ… åŠŸèƒ½ç­‰ä»· | ä½†ç»“æ„ä¸åŒï¼ˆæ— æƒé‡å…±äº«ï¼‰ |
| **LSTM é—¨æ§ç»“æ„** | âš ï¸ ç†è®ºå¯èƒ½ï¼Œå®é™…æéš¾ | éœ€è¦æå¤§æœç´¢ç©ºé—´ï¼Œæ¦‚ç‡è¶‹è¿‘äº 0 |
| **Transformer/Attention** | âŒ å‡ ä¹ä¸å¯èƒ½ | QÂ·K^TÂ·V æ¨¡å¼å¤ªç‰¹æ®Š |

**å…³é”®æ´å¯Ÿ**ï¼šNEAT å¾ªç¯æ˜¯æ›´åº•å±‚ã€æ›´é€šç”¨çš„"è®°å¿†"æ¦‚å¿µï¼Œä½†å®ƒä¸ä¼šè‡ªç„¶äº§ç”Ÿæƒé‡å…±äº«æˆ–é—¨æ§æœºåˆ¶ã€‚LSTM/Attention ç­‰æ˜¯äººç±»è®¾è®¡çš„**å¼ºå½’çº³åç½®**ï¼Œç›®çš„æ˜¯è®©å­¦ä¹ æ›´ç¨³å®šã€æ›´é«˜æ•ˆâ€”â€”è€Œéå¢åŠ è¡¨è¾¾èƒ½åŠ›ã€‚

> ğŸ’¡ **å®è¯æ¡ˆä¾‹**ï¼ˆæ¥è‡ª [NEAT åŸå§‹è®ºæ–‡](../paper/NEAT_2002/summary.md)ï¼‰ï¼š
>
> åœ¨**åŒæ†å¹³è¡¡æ— é€Ÿåº¦ä¿¡æ¯**ï¼ˆDPNVï¼‰ä»»åŠ¡ä¸­ï¼Œç½‘ç»œå¿…é¡»ä»å†å²ä½ç½®ä¿¡æ¯æ¨æ–­é€Ÿåº¦â€”â€”è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„**éé©¬å°”å¯å¤«**ä»»åŠ¡ï¼Œéœ€è¦è®°å¿†æœºåˆ¶ã€‚NEAT æ¼”åŒ–å‡ºçš„è§£ä»…ä½¿ç”¨ **1 ä¸ªéšè—èŠ‚ç‚¹ + 1 æ¡è‡ªè¿æ¥**ï¼Œé€šè¿‡è®¡ç®—è§’åº¦å·®çš„å¯¼æ•°æ¥ä¼°è®¡é€Ÿåº¦ï¼Œæ— éœ€å¤æ‚çš„é—¨æ§æœºåˆ¶ã€‚è¿™è¯æ˜äº†ï¼š
> - ç®€å•å¾ªç¯è¿æ¥å¯¹äº**çŸ­æœŸè®°å¿†**ä»»åŠ¡è¶³å¤Ÿ
> - ä¸æ˜¯æ‰€æœ‰éœ€è¦è®°å¿†çš„ä»»åŠ¡éƒ½éœ€è¦ LSTM/GRU
> - ä½†å¯¹äº**é•¿æœŸä¾èµ–**ï¼Œé—¨æ§æœºåˆ¶ä»æœ‰ä¼˜åŠ¿ï¼ˆå‚è§ [EXAMM è®ºæ–‡](../paper/EXAMM_2019/summary.md)çš„å¯¹æ¯”å®éªŒï¼‰

### 1.4 å…³é”®è®¾è®¡å†³ç­–

- **å•æ­¥æ°¸è¿œæ˜¯ DAG**ï¼šå¾ªç¯è¾¹çš„"ç¯"æ˜¯æ—¶é—´ç»´åº¦çš„ï¼Œä¸æ˜¯å›¾ç»“æ„çš„
- **State â‰  Input**ï¼šState èŠ‚ç‚¹å¯æ¥æ”¶æ¢¯åº¦ï¼ŒInput èŠ‚ç‚¹ä¸å¯
- **BPTT = æ—¶é—´è°ƒåº¦**ï¼šä¸æ˜¯"é‡å¤è°ƒç”¨ backward"ï¼Œè€Œæ˜¯æ‰§è¡Œå™¨ç®¡ç†çš„è·¨æ—¶é—´æ¢¯åº¦ä¼ é€’
- **NEAT å¾ªç¯è¾¹ = Delay è¾¹**ï¼šç»Ÿä¸€çš„æŠ½è±¡ï¼Œ`recurrent_depth` åªæ˜¯ Delay çš„æ­¥æ•°

---

## 2. VJP è§£é‡Šï¼ˆVector-Jacobian Productï¼‰

### 2.1 ä»€ä¹ˆæ˜¯ VJP

**VJPï¼ˆå‘é‡-é›…å¯æ¯”ä¹˜ç§¯ï¼‰** æ˜¯åå‘ä¼ æ’­çš„æ•°å­¦æ ¸å¿ƒï¼Œç›¸æ¯”æ˜¾å¼ Jacobian çŸ©é˜µæ›´é«˜æ•ˆï¼š

```
ä¼ ç»Ÿ Jacobian æ–¹å¼ï¼š
  y = f(x)     // x æ˜¯ [N] å‘é‡ï¼Œy æ˜¯ [M] å‘é‡
  J = âˆ‚y/âˆ‚x   // Jacobian çŸ©é˜µ [M Ã— N]
  âˆ‚L/âˆ‚x = (âˆ‚L/âˆ‚y)áµ€ Â· J   // éœ€è¦å­˜å‚¨å®Œæ•´çš„ [M Ã— N] çŸ©é˜µ

VJP æ–¹å¼ï¼š
  y = f(x)
  âˆ‚L/âˆ‚x = vjp(f, x, âˆ‚L/âˆ‚y)   // ç›´æ¥è®¡ç®—ç»“æœå‘é‡ [N]ï¼Œæ— éœ€æ„é€  [M Ã— N] çŸ©é˜µ
```

### 2.2 ä¸ºä»€ä¹ˆ VJP æ›´é«˜æ•ˆ

| åœºæ™¯ | Jacobian å†…å­˜ | VJP å†…å­˜ |
|------|--------------|---------|
| batch=64, hidden=256 | O(NÂ²) = 4MB/èŠ‚ç‚¹ | O(N) = 64KB/èŠ‚ç‚¹ |
| tanh èŠ‚ç‚¹ | [16384 Ã— 16384] å¯¹è§’é˜µ | [16384] å‘é‡ |

### 2.3 ä»£ç å¯¹åº”

```rust
// Jacobian æ¨¡å¼ï¼ˆç”¨äºå•æ ·æœ¬è°ƒè¯•ï¼‰
node.calc_jacobi_to_a_parent(...)  // è¿”å› [1, N] æˆ– [N, M] çŸ©é˜µ

// VJP æ¨¡å¼ï¼ˆç”¨äºè®­ç»ƒï¼‰
node.calc_grad_to_parent(parent, upstream_grad, ...)  // è¿”å›ä¸ parent åŒå½¢çš„æ¢¯åº¦
```

---

## 3. èŠ‚ç‚¹ç±»å‹

| ç±»å‹ | å€¼æ¥æº | æ¥æ”¶æ¢¯åº¦ | ä¼˜åŒ–å™¨å‚ä¸ | ç”¨é€” |
|------|-------|---------|----------|------|
| `Input` | ç”¨æˆ·è®¾ç½® | âŒ | âŒ | å¤–éƒ¨æ•°æ®è¾“å…¥ |
| `Parameter` | åˆå§‹åŒ–+ä¼˜åŒ–å™¨ | âœ… | âœ… | å¯å­¦ä¹ æƒé‡ |
| `State` | æ‰§è¡Œå™¨æ³¨å…¥ | âœ… | âŒ | RNN éšè—çŠ¶æ€ |

**State èŠ‚ç‚¹çš„è¯­ä¹‰**ï¼šState æ˜¯"è¦è®°çš„ä¸œè¥¿"ï¼Œä¸æ˜¯"è¦å­¦çš„ä¸œè¥¿"ã€‚

```rust
// state.rs ä¸­çš„å…³é”®è®¾è®¡
impl TraitNode for State {
    fn set_jacobi(...) { ... }  // Input èŠ‚ç‚¹ä¸å®ç°è¿™ä¸ª
    fn set_grad(...) { ... }    // VJP æ¨¡å¼æ”¯æŒ
}
```

---

## 4. åˆ†å±‚æ¶æ„

### 4.1 ä¸‰å±‚è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 0: åŸå­èŠ‚ç‚¹ï¼ˆæ ¸å¿ƒï¼Œå¿…é¡»ï¼‰                              â”‚
â”‚  â”œâ”€â”€ MatMul, Add, Sigmoid, Tanh, Softmax, Concat, ...       â”‚
â”‚  â”œâ”€â”€ State èŠ‚ç‚¹ï¼ˆå¾ªç¯çŠ¶æ€ï¼‰                                   â”‚
â”‚  â””â”€â”€ step() / reset() è¯­ä¹‰                                   â”‚
â”‚                                                             â”‚
â”‚  è¿™æ˜¯ NEAT å¯ä»¥æ“ä½œçš„æœ€å°å•å…ƒ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Level 1: æ¨¡æ¿å±‚ï¼ˆå¯é€‰ï¼Œä¾¿æ· APIï¼‰                            â”‚
â”‚  â”œâ”€â”€ RNNCell, LSTMCell, GRUCell, âˆ†-RNNCell                  â”‚
â”‚  â””â”€â”€ æœ¬è´¨æ˜¯åŸå­èŠ‚ç‚¹çš„ç»„åˆï¼Œä¸æ˜¯æ–°çš„æ ¸å¿ƒæ¦‚å¿µ                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Level 2: æ‰§è¡Œå¼•æ“                                           â”‚
â”‚  â”œâ”€â”€ BPTT æ—¶é—´è°ƒåº¦                                          â”‚
â”‚  â”œâ”€â”€ TBPTT æˆªæ–­                                             â”‚
â”‚  â””â”€â”€ NEAT è¿›åŒ–ç®—æ³•                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ä¸äº”å±‚æ¶æ„çš„å¯¹é½

> å‚è€ƒ [é«˜å±‚æ¶æ„è®¾è®¡](./../_archive/high_level_architecture_design.md)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬5å±‚ï¼šåº•å±‚è®¡ç®—å±‚ï¼ˆGraph/Node/Tensorï¼‰                           â”‚
â”‚   èŒè´£ï¼šå•æ­¥ DAG çš„å‰å‘/å±€éƒ¨æ±‚å¯¼                                 â”‚
â”‚   âš ï¸ ä¸åº”çŸ¥é“"æ—¶é—´"çš„æ¦‚å¿µ                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¬4å±‚ï¼šä¸­é—´è¡¨ç¤ºå±‚ï¼ˆComputationGraph/IRï¼‰                         â”‚
â”‚   èŒè´£ï¼šç»Ÿä¸€è®¡ç®—å›¾è¡¨ç¤º                                           â”‚
â”‚   State èŠ‚ç‚¹ç±»å‹å®šä¹‰åœ¨æ­¤å±‚                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¬3å±‚ï¼šæ‰§è¡Œå¼•æ“å±‚ï¼ˆExecutionEngineï¼‰                             â”‚
â”‚   èŒè´£ï¼šBPTT æ—¶é—´è°ƒåº¦ã€è·¨æ—¶é—´æ¢¯åº¦ç§»ä½ã€TBPTT æˆªæ–­               â”‚
â”‚   BPTT çš„"å±•å¼€/æ¢¯åº¦ä¼ é€’"é€»è¾‘åœ¨æ­¤å±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¬2å±‚ï¼šæ¼”åŒ–APIå±‚ï¼ˆNEATï¼‰                                         â”‚
â”‚   èŒè´£ï¼šç»“æ„å˜å¼‚ã€ç‰©ç§å½¢æˆã€recurrent_depth é…ç½®                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¬1å±‚ï¼šç”¨æˆ·APIå±‚ï¼ˆModule/Optimizer/DataLoaderï¼‰                  â”‚
â”‚   ç”¨æˆ·æ— æ„ŸçŸ¥æ—¶é—´è°ƒåº¦ç»†èŠ‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®æ´å¯Ÿ**ï¼šBPTT ä¸æ˜¯"æŠŠå•æ­¥ backward è°ƒ 3 æ¬¡"ï¼Œè€Œæ˜¯**æ‰§è¡Œå™¨å±‚é¢çš„æ—¶é—´è°ƒåº¦é—®é¢˜**ã€‚

### 4.3 è®­ç»ƒæ–¹æ³•é€‰æ‹©

| åœºæ™¯ | æ¨èæ–¹æ³• |
|------|---------|
| çŸ­åºåˆ— + éœ€è¦é•¿ç¨‹ä¾èµ– | Full BPTTï¼ˆæ¢¯åº¦ä¸‹é™ï¼‰ |
| é•¿åºåˆ— + å†…å­˜æœ‰é™ | TBPTTï¼ˆæˆªæ–­åå‘ä¼ æ’­ï¼‰ |
| ç»“æ„æœç´¢ + å°è§„æ¨¡ä»»åŠ¡ | NEAT è¿›åŒ–ï¼ˆæ— æ¢¯åº¦ï¼‰ |
| æ··åˆç­–ç•¥ | NEAT æœç´¢ç»“æ„ + æ¢¯åº¦å¾®è°ƒæƒé‡ |

---

## 5. å®ç°è·¯å¾„

### 5.1 Phase 1: åŸºç¡€å¾ªç¯æ”¯æŒ âœ…

**ç›®æ ‡**ï¼šå®ç°è®°å¿†æœºåˆ¶çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½

- [x] `recurrent_edges: HashMap<NodeId, NodeId>` å£°æ˜å¾ªç¯è¿æ¥
- [x] `prev_values: HashMap<NodeId, Tensor>` åŒç¼“å†²
- [x] `step()` / `reset()` / `connect_recurrent()` API
- [x] `current_time_step()` / `has_recurrent_edges()` æŸ¥è¯¢

**åŒç¼“å†²æœºåˆ¶**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  step() æµç¨‹ï¼š                                              â”‚
â”‚  1. å°† prev_values ä¼ é€’ç»™å¾ªç¯ç›®æ ‡èŠ‚ç‚¹ï¼ˆStateï¼‰               â”‚
â”‚  2. æ‰§è¡Œæ­£å¸¸å‰å‘ä¼ æ’­                                         â”‚
â”‚  3. å°†å¾ªç¯æºèŠ‚ç‚¹çš„å½“å‰å€¼å­˜å…¥ prev_values                     â”‚
â”‚  4. ä¿å­˜å¿«ç…§ç”¨äº BPTTï¼ˆè®­ç»ƒæ¨¡å¼ä¸‹ï¼‰                          â”‚
â”‚                                                             â”‚
â”‚  reset() æµç¨‹ï¼š                                             â”‚
â”‚  1. æ¸…ç©º prev_values å’Œ step_history                        â”‚
â”‚  2. å°†å¾ªç¯ç›®æ ‡èŠ‚ç‚¹é‡ç½®ä¸ºé›¶                                   â”‚
â”‚  3. æ—¶é—´æ­¥å½’é›¶                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éªŒæ”¶**ï¼š8 ä¸ªå•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼ˆè§ `src/nn/tests/recurrent_basic.rs`ï¼‰

### 5.2 Phase 2: BPTT è®­ç»ƒ âœ…

**ç›®æ ‡**ï¼šæ”¯æŒåŸºäºæ¢¯åº¦çš„æ—¶é—´åºåˆ—è®­ç»ƒ

#### 5.2.1 å·²å®ç°

- [x] æ—¶é—´æ­¥å±•å¼€ï¼ˆéšå¼å±•å¼€ + å¿«ç…§æœºåˆ¶ï¼‰
- [x] TBPTT æˆªæ–­é€‰é¡¹
- [x] å‰å‘ä¼ æ’­ç»“æœä¸ PyTorch å®Œå…¨åŒ¹é…
- [x] BPTT æ¢¯åº¦ä¸ PyTorch å®Œå…¨åŒ¹é…

#### 5.2.2 æ¶æ„é—®é¢˜å‘ç°ä¸è§£å†³ï¼ˆå†å²è®°å½•ï¼‰

**é—®é¢˜**ï¼šæœ€åˆå°† `h_prev` å®ç°ä¸º Input èŠ‚ç‚¹ï¼Œè€Œ Input èŠ‚ç‚¹ä¸æ¥æ”¶æ¢¯åº¦ï¼Œå¯¼è‡´è·¨æ—¶é—´æ¢¯åº¦é“¾æ–­è£‚ã€‚

**è¯æ®**ï¼ˆPyTorch å¯¹ç…§ï¼‰ï¼š

| å‚æ•° | PyTorch æ¢¯åº¦ | ä¿®å¤å‰ | ä¿®å¤å |
|-----|-------------|-------|-------|
| `w_out` | -0.134053 | -0.134053 âœ… | -0.134053 âœ… |
| `w_scale` | -0.025092 | -0.020124 âŒ | -0.025092 âœ… |

**æ ¹æœ¬åŸå› **ï¼šInput èŠ‚ç‚¹åœ¨æ¶æ„ä¸­æ˜¯"æ¢¯åº¦æ±‡ç‚¹"ï¼Œä½† RNN çš„ hidden state åº”è¯¥æ˜¯**å¯å¯¼çš„ä¸­é—´é‡**ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå¼•å…¥ State èŠ‚ç‚¹ç±»å‹ï¼ˆè§ Phase 2.5ï¼‰

#### 5.2.3 æ ¸å¿ƒ API

```rust
// å®Œæ•´ BPTT
graph.backward_through_time(&[params], loss)?;

// æˆªæ–­ BPTTï¼ˆåªåå‘ä¼ æ’­æœ€è¿‘ k æ­¥ï¼‰
graph.backward_through_time_truncated(&[params], loss, Some(k))?;

// æŸ¥è¯¢
graph.history_len()      // å½“å‰å†å²æ­¥æ•°
graph.clear_history()    // æ¸…é™¤å†å²ï¼ˆä¿ç•™å¾ªç¯çŠ¶æ€ï¼‰
```

### 5.3 Phase 2.5: State èŠ‚ç‚¹ç±»å‹ âœ…

**ç›®æ ‡**ï¼šä¿®å¤è·¨æ—¶é—´æ¢¯åº¦ä¼ é€’

**å®ç°**ï¼š`src/nn/nodes/raw_node/state.rs`

```rust
pub struct State {
    value: Option<Tensor>,
    jacobi: Option<Tensor>,  // Jacobian æ¨¡å¼æ¢¯åº¦
    grad: Option<Tensor>,    // VJP æ¨¡å¼æ¢¯åº¦
    shape: Vec<usize>,
}
```

**éªŒæ”¶**ï¼š12 ä¸ªå•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼ˆè§ `src/nn/tests/node_state.rs`ï¼‰

### 5.4 Phase 2 æ”¹è¿›ï¼šé€šç”¨åŒ–ä¸æ•ˆç‡ä¼˜åŒ– âœ…

BPTT æœ€åˆå®ç°æœ‰ä¸¤ä¸ªé™åˆ¶ï¼Œç°å·²ä¿®å¤ï¼š

1. **ç¡¬ç¼–ç  tanh å¯¼æ•°** â†’ æ”¹ä¸ºé€šç”¨ "seeded backward"
   - ç°åœ¨æ”¯æŒä»»æ„æ¿€æ´»å‡½æ•°ç»„åˆï¼ˆtanh/sigmoid/æ··åˆï¼‰
   - åŸåˆ™ï¼šBPTT åªè´Ÿè´£æ—¶é—´è°ƒåº¦ï¼Œæ¿€æ´»å¯¼æ•°äº¤ç»™ Node

2. **Jacobian æ¨¡å¼å†…å­˜çˆ†ç‚¸** â†’ æ”¹ä¸º VJP æ¨¡å¼
   - Jacobianï¼šelementwise èŠ‚ç‚¹äº§ç”Ÿ NÃ—N çŸ©é˜µ
   - VJPï¼šç›´æ¥è®¡ç®— N ç»´æ¢¯åº¦å‘é‡
   - æ•ˆæœï¼šbatch=64, hidden=256 å¯æ­£å¸¸è®­ç»ƒ

**æ ¸å¿ƒ VJP å‡½æ•°**ï¼š
- `backward_from_loss_vjp()` â€” loss â†’ å‚æ•°
- `bptt_backward_from_node_vjp()` â€” ä¸­é—´èŠ‚ç‚¹ â†’ å‚æ•°
- `bptt_propagate_to_state_vjp()` â€” ä¼ æ’­åˆ° State èŠ‚ç‚¹

### 5.5 Phase 3: æ¨¡æ¿å±‚ â³

**ç›®æ ‡**ï¼šæä¾›ä¾¿æ·çš„å¾ªç¯å±‚ API

**ä¼˜å…ˆçº§**ï¼ˆæŒ‰ EXAMM è®ºæ–‡æ¨èï¼‰ï¼š

| å•å…ƒ | é—¨æ•°é‡ | çŠ¶æ€ | è¯´æ˜ |
|------|--------|------|------|
| âˆ†-RNN | 1 | â³ ä¼˜å…ˆ | æ€§ä»·æ¯”æœ€é«˜ |
| GRU | 2 | â³ | ç¨³å®šé€‰æ‹© |
| LSTM | 3 | â³ | å¤æ‚ä½†ä¸ä¸€å®šæ›´å¥½ |

**âˆ†-RNN å…¬å¼**ï¼š
```
z_t = Ïƒ(x_t Â· W_xz + h_{t-1} Â· W_hz)
h_t = (1 - z_t) âŠ™ h_{t-1} + z_t âŠ™ tanh(x_t Â· W_xh)
```

### 5.6 Phase 4: NEAT é›†æˆ â³

**ç›®æ ‡**ï¼šæ”¯æŒç½‘ç»œç»“æ„è¿›åŒ–

- [ ] è¿æ¥çº§å˜å¼‚ï¼ˆæ·»åŠ /åˆ é™¤è¾¹ï¼‰
- [ ] èŠ‚ç‚¹çº§å˜å¼‚ï¼ˆæ·»åŠ /åˆ é™¤èŠ‚ç‚¹ï¼‰
- [ ] ç‰©ç§å½¢æˆï¼ˆspeciationï¼‰
- [ ] å¯é…ç½® `recurrent_depth`ï¼ˆ1-N æ—¶é—´æ­¥è·³è·ƒï¼‰
- [ ] Lamarckian æƒé‡ç»§æ‰¿

---

## 6. å½“å‰ Loss æ¨¡å¼ï¼šMany-to-One

### 6.1 å½“å‰å®ç°

å½“å‰ BPTT å®ç°ä¸­ï¼Œ**åªæœ‰æœ€åä¸€ä¸ªæ—¶é—´æ­¥ä» loss åå‘ä¼ æ’­**ï¼Œä¸­é—´æ—¶é—´æ­¥åªä¼ é€’æ¥è‡ªæœªæ¥çš„æ¢¯åº¦ï¼š

```rust
// t=Tï¼ˆæœ€åä¸€æ­¥ï¼‰ï¼šä» loss åå‘ä¼ æ’­
let state_grads = self.backward_from_loss_vjp(...)?;

// t<Tï¼ˆä¸­é—´æ­¥ï¼‰ï¼šåªä» incoming_grad ä¼ æ’­
self.bptt_backward_from_node_vjp(from_node, incoming_grad, ...)?;
```

è¿™å¯¹åº” **many-to-one** ä»»åŠ¡ï¼ˆå¦‚åºåˆ—åˆ†ç±»ï¼‰ï¼š

```
è¾“å…¥åºåˆ—: [x_1, x_2, x_3, ..., x_T]
è¾“å‡º: y_Tï¼ˆåªåœ¨æœ€åä¸€æ­¥æœ‰ lossï¼‰
```

### 6.2 Many-to-Many æ”¯æŒï¼ˆæœªæ¥æ‰©å±•ï¼‰

å¯¹äº **many-to-many** ä»»åŠ¡ï¼ˆå¦‚è¯­è¨€æ¨¡å‹ï¼Œæ¯æ­¥éƒ½æœ‰ lossï¼‰ï¼š

```
è¾“å…¥åºåˆ—: [x_1, x_2, x_3, ..., x_T]
è¾“å‡ºåºåˆ—: [y_1, y_2, y_3, ..., y_T]ï¼ˆæ¯æ­¥éƒ½æœ‰ loss è´¡çŒ®ï¼‰
```

éœ€è¦åœ¨æ¯ä¸ªæ—¶é—´æ­¥éƒ½ä» loss åå‘ä¼ æ’­ï¼Œç„¶å**åˆå¹¶**æ¥è‡ª loss å’Œæ¥è‡ªæœªæ¥çš„æ¢¯åº¦ï¼š

```rust
// æ¯ä¸ªæ—¶é—´æ­¥ï¼š
// grad = grad_from_loss + grad_from_future
```

è¿™æ˜¯ Phase 3 çš„å¯é€‰æ‰©å±•ã€‚

### 6.3 å˜é•¿åºåˆ—å¤„ç†ï¼šPadding + Mask

**é—®é¢˜**ï¼šBatch è®­ç»ƒæ—¶ï¼Œä¸åŒæ ·æœ¬åºåˆ—é•¿åº¦ä¸åŒï¼Œå¦‚ä½•å¯¹é½ï¼Ÿ

**æ–¹æ¡ˆ**ï¼šé‡‡ç”¨ç»å…¸çš„ **Padding + Mask** æœºåˆ¶ï¼š

1. **Padding**ï¼šå°†æ‰€æœ‰åºåˆ—å¡«å……åˆ° `max_len`ï¼ŒçŸ­åºåˆ—ç”¨ 0ï¼ˆæˆ–ç‰¹æ®Š tokenï¼‰å¡«å……
2. **Mask**ï¼šç”Ÿæˆ `[batch, 1]` æˆ– `[batch, hidden]` çš„ mask å¼ é‡ï¼Œæ ‡è®°æœ‰æ•ˆæ—¶é—´æ­¥

**çŠ¶æ€å†»ç»“å…¬å¼**ï¼š

```
h_t = mask_t âŠ™ hÌƒ_t + (1 - mask_t) âŠ™ h_{t-1}
```

å…¶ä¸­ï¼š
- `hÌƒ_t` = æ­£å¸¸ RNN æ›´æ–°åçš„éšè—çŠ¶æ€
- `mask_t` = 1 è¡¨ç¤ºè¯¥æ ·æœ¬åœ¨ t æ—¶åˆ»ä»æœ‰æ•ˆï¼Œ0 è¡¨ç¤ºå·²ç»“æŸ
- ç»“æœï¼šç»“æŸåçš„æ ·æœ¬ï¼Œå…¶éšè—çŠ¶æ€è¢«"å†»ç»“"åœ¨æœ€åæœ‰æ•ˆæ—¶åˆ»

**å…¼å®¹æ€§**ï¼šæ­¤æœºåˆ¶ä¸æ‰€æœ‰ä»»åŠ¡ç±»å‹å…¼å®¹ï¼š

| ä»»åŠ¡ç±»å‹ | mask ä½œç”¨ç‚¹ | è¯´æ˜ |
|---------|-----------|------|
| many-to-one | çŠ¶æ€æ›´æ–° | å†»ç»“ç»“æŸåçš„ hiddenï¼Œæœ€ç»ˆåªå–ä¸€æ¬¡ loss |
| many-to-many | çŠ¶æ€æ›´æ–° + loss | å†»ç»“ hidden + åªå¯¹æœ‰æ•ˆæ­¥è®¡ loss |
| one-to-many | loss | åªå¯¹æœ‰æ•ˆè¾“å‡ºæ­¥è®¡ loss |
| one-to-one | é€šå¸¸ä¸éœ€è¦ | é•¿åº¦ä¸º 1 æˆ–åŒæ­¥æ˜ å°„ |

**å®ç°æ–¹å¼ï¼ˆå½“å‰åŸå­èŠ‚ç‚¹ï¼‰**ï¼š

```rust
// åœ¨å›¾ä¸­æ·»åŠ  mask è¾“å…¥ï¼ˆæ¯æ—¶é—´æ­¥æ›´æ–°ï¼‰
let mask = graph.new_input_node(&[batch, hidden], Some("mask"))?;

// è®¡ç®— hÌƒ_tï¼ˆæ­£å¸¸ RNN æ›´æ–°ï¼‰
let h_tilde = graph.new_tanh_node(pre_hidden, None)?;

// è®¡ç®— delta = hÌƒ_t - h_prev
let neg_h_prev = graph.new_scalar_multiply_node(neg_one, h_prev, None)?;
let delta = graph.new_add_node(&[h_tilde, neg_h_prev], None)?;

// h_t = h_prev + mask * delta
let masked_delta = graph.new_multiply_node(mask, delta, None)?;
let hidden = graph.new_add_node(&[h_prev, masked_delta], None)?;
```

**éªŒæ”¶æµ‹è¯•**ï¼šIT-3aï¼ˆè§ç¬¬ 8 èŠ‚ï¼‰

---

## 7. æœªæ¥è€ƒè™‘

### 7.1 å¯é…ç½® recurrent_depth

å½“å‰å®ç°åªæ”¯æŒ `depth=1`ï¼ˆæ ‡å‡† RNN å¾ªç¯ï¼‰ã€‚EXAMM æ”¯æŒ `depth=1-10`ã€‚

```rust
// å½“å‰
recurrent_edges: HashMap<NodeId, NodeId>

// æœªæ¥å¯èƒ½
recurrent_edges: HashMap<NodeId, (NodeId, u32)>  // (from_node, depth)
```

`depth>1` ç›¸å½“äºæ—¶é—´ç»´åº¦çš„ skip connectionï¼Œå¯¹æŸäº›ä»»åŠ¡å¯èƒ½æœ‰ç›Šã€‚

### 7.2 å¯å­¦ä¹ çš„åˆå§‹éšè—çŠ¶æ€

å½“å‰ `reset()` å°† State é‡ç½®ä¸ºé›¶ã€‚æŸäº›ä»»åŠ¡éœ€è¦å¯å­¦ä¹ çš„åˆå§‹çŠ¶æ€ï¼š

```rust
// æ–¹æ¡ˆï¼šæ·»åŠ å¯é€‰çš„åˆå§‹ State å‚æ•°
let h_0 = graph.new_parameter_node(&[batch, hidden], Some("h_0"))?;
graph.set_initial_state(h_prev, h_0)?;
```

---

## 8. é›†æˆæµ‹è¯•ç­–ç•¥

é‡‡ç”¨**æ¸è¿›å¼éªŒè¯**ï¼š

| é˜¶æ®µ | æµ‹è¯•ç±»å‹ | Batch | çŠ¶æ€ |
|------|---------|-------|------|
| IT-1 | å¥‡å¶æ€§æ£€æµ‹ï¼ˆå›ºå®šé•¿åº¦ï¼‰ | âŒ å•åºåˆ— | âœ… 98% å‡†ç¡®ç‡ |
| IT-2 | å¥‡å¶æ€§æ£€æµ‹ï¼ˆå›ºå®šé•¿åº¦ï¼‰ | âœ… Batch | âœ… æ¢¯åº¦æ­£ç¡® |
| IT-3a | å¥‡å¶æ€§æ£€æµ‹ï¼ˆå˜é•¿ + Padding/Maskï¼‰ | âœ… Batch | âœ… 96.9% å‡†ç¡®ç‡ |
| IT-3b | å¥‡å¶æ€§æ£€æµ‹ï¼ˆå˜é•¿ + æ¨¡æ¿å±‚ APIï¼‰ | âœ… Batch | Phase 3 å |

**IT-3a vs IT-3b**ï¼š
- **IT-3a**ï¼šç”¨åŸå­èŠ‚ç‚¹æ‰‹å·¥å®ç° padding + maskï¼ŒéªŒè¯å˜é•¿è¯­ä¹‰çš„æ ¸å¿ƒæ­£ç¡®æ€§
- **IT-3b**ï¼šç”¨ Phase 3 æ¨¡æ¿å±‚ API é‡å†™åŒä¸€æµ‹è¯•ï¼ŒéªŒæ”¶å°è£…æ˜“ç”¨æ€§

**å¥‡å¶æ€§æ£€æµ‹ä»»åŠ¡**ï¼š

```
è¾“å…¥ï¼š0/1 åºåˆ—ï¼ˆå¦‚ [1,0,1,1,0]ï¼‰
è¾“å‡ºï¼š1 çš„ä¸ªæ•°æ˜¯å¥‡æ•°(1)è¿˜æ˜¯å¶æ•°(0)

ä¸ºä»€ä¹ˆé€‰è¿™ä¸ªä»»åŠ¡ï¼š
âœ… å¿…é¡»æœ‰è®°å¿†æ‰èƒ½è§£å†³
âœ… ç®€å•çš„äºŒåˆ†ç±»ï¼Œ100% å‡†ç¡®ç‡å¯è¾¾
âœ… å¯è‡ªåŠ¨ç”Ÿæˆæ— é™è®­ç»ƒæ•°æ®
```

---

## 9. å¼€æºé¡¹ç›®è®°å¿†æœºåˆ¶å¯¹æ¯”

### 9.1 æ ¸å¿ƒå¯¹æ¯”è¡¨

| ç»´åº¦ | neat-python | neat-rs | EXACT/EXAMM | neat-gru-rust |
|------|-------------|---------|-------------|---------------|
| **è¯­è¨€** | Python | Rust | C++ | Rust |
| **å¾ªç¯æ”¯æŒ** | âœ… ä»»æ„æ‹“æ‰‘ | âŒ ä»…å‰é¦ˆ | âœ… å¾ªç¯è¾¹ + é¢„åˆ¶å•å…ƒ | âœ… GRU è¿æ¥ |
| **åŒç¼“å†²** | âœ… | N/A | âœ… | âœ… |
| **é¢„åˆ¶è®°å¿†å•å…ƒ** | âŒ | âŒ | âœ… 6 ç§ | âœ… GRU |
| **recurrent_depth** | 1 æ­¥å›ºå®š | N/A | 1-10 æ­¥ | 1 æ­¥å›ºå®š |
| **è®­ç»ƒæ–¹æ³•** | çº¯è¿›åŒ– | çº¯è¿›åŒ– | è¿›åŒ– + BPTT | çº¯è¿›åŒ– |
| **Lamarckian ç»§æ‰¿** | âŒ | âŒ | âœ… | âŒ |

### 9.2 å…³é”®å€Ÿé‰´

| å€Ÿé‰´æ¥æº | é‡‡çº³å†…å®¹ | ä¼˜å…ˆçº§ |
|---------|---------|--------|
| neat-python | åŒç¼“å†²æœºåˆ¶ | ğŸ”´ å¿…é¡»ï¼ˆå·²å®ç°ï¼‰ |
| æ‰€æœ‰é¡¹ç›® | éšå¼ hidden state + reset() | ğŸ”´ å¿…é¡»ï¼ˆå·²å®ç°ï¼‰ |
| EXAMM | å¯é…ç½® recurrent_depth | ğŸŸ¡ å»ºè®®ï¼ˆPhase 4ï¼‰ |
| EXAMM | Lamarckian æƒé‡ç»§æ‰¿ | ğŸŸ¡ å»ºè®®ï¼ˆPhase 4ï¼‰ |
| EXAMM | âˆ†-RNN ä½œä¸ºè½»é‡çº§æ¨¡æ¿ | ğŸŸ¢ å¯é€‰ï¼ˆPhase 3ï¼‰ |
| neat-rs | âŒ **é¿å…**ç¦æ­¢å¾ªç¯çš„è®¾è®¡ | â€” |

### 9.3 EXAMM è®ºæ–‡å…³é”®æ´å¯Ÿ

1. æ²¡æœ‰"ä¸‡èƒ½"è®°å¿†å•å…ƒ â€” ä¸åŒä»»åŠ¡æœ€ä¼˜å•å…ƒä¸åŒ
2. **ç®€å•ç¥ç»å…ƒ + å¤æ‚è®°å¿†å•å…ƒæ··åˆæ•ˆæœæœ€ä½³**
3. âˆ†-RNN æ€§ä»·æ¯”æœ€é«˜ï¼ˆ1 ä¸ªé—¨ï¼Œè¡¨ç°æ¥è¿‘ LSTMï¼‰
4. æ¼”åŒ–å‡ºçš„ç½‘ç»œéå¸¸ç´§å‡‘ï¼ˆå¹³å‡ 16-29 éšè—èŠ‚ç‚¹ï¼Œ3-8 å¾ªç¯è¾¹ï¼‰

---

## 10. å…³é”® API ç¤ºä¾‹

```rust
// åˆ›å»ºå¾ªç¯ç½‘ç»œ
let h_prev = graph.new_state_node(&[batch, hidden], Some("h_prev"))?;
graph.set_node_value(h_prev, Some(&Tensor::zeros(&[batch, hidden])))?;

let pre_hidden = graph.new_add_node(&[input_contrib, hidden_contrib], None)?;
let hidden = graph.new_tanh_node(pre_hidden, Some("hidden"))?;
graph.connect_recurrent(hidden, h_prev)?;

// è®­ç»ƒå¾ªç¯
for input in sequence {
    graph.set_node_value(x, Some(&input))?;
    graph.step(loss)?;
}
graph.backward_through_time(&params, loss)?;

// SGD æ›´æ–°
for &p in &params {
    if let Some(grad) = graph.get_node_jacobi(p)? {
        let val = graph.get_node_value(p)?.unwrap();
        let grad_reshaped = grad.reshape(val.shape());
        graph.set_node_value(p, Some(&(val - &grad_reshaped * lr)))?;
    }
}
graph.reset();  // æ–°åºåˆ—å‰é‡ç½®
```

---

## 11. ç›¸å…³è®ºæ–‡ä¸èµ„æº

### NEAT æ ¸å¿ƒ

- **NEAT åŸå§‹è®ºæ–‡**ï¼š[Evolving Neural Networks through Augmenting Topologies](http://nn.cs.utexas.edu/downloads/papers/stanley.ec02.pdf) â€” [æœ¬åœ°ç¬”è®°](../paper/NEAT_2002/summary.md)
- **NEAT åç»­ç»¼è¿°ï¼ˆ2021ï¼‰**ï¼š[A Systematic Literature Review of the Successors of NeuroEvolution of Augmenting Topologies](https://cris.vub.be/ws/files/75376010/A_Systematic_Literature_Review_of_the.pdf)

### NEAT + å¾ªç¯/è®°å¿†

- **EXAMM**ï¼š[Investigating Recurrent Neural Network Memory Structures using Neuro-Evolution](https://arxiv.org/abs/1902.02390) â€” [æœ¬åœ°ç¬”è®°](../paper/EXAMM_2019/summary.md)
- **EXALT/EXAMM æ¡†æ¶**ï¼šhttps://github.com/travisdesell/exact

### RNN/BPTT

- **BPTT åŸå§‹è®ºæ–‡**ï¼š[Learning representations by back-propagating errors](https://www.nature.com/articles/323533a0) - Rumelhart et al., 1986
- **LSTM**ï¼š[Long Short-Term Memory](https://www.bioinf.jku.at/publications/older/2604.pdf) - Hochreiter & Schmidhuber, 1997
- **GRU**ï¼š[Learning Phrase Representations using RNN Encoder-Decoder](https://arxiv.org/abs/1406.1078) - Cho et al., 2014

### å®ç°å‚è€ƒ

- **neat-python**ï¼šhttps://github.com/CodeReclaimers/neat-python
- **PyTorch-NEAT**ï¼šhttps://github.com/uber-research/PyTorch-NEAT
- **radiate**ï¼šhttps://github.com/pkalivas/radiate
- **neat-gru-rust**ï¼šhttps://github.com/sakex/neat-gru-rust

---

## 12. æ€»ç»“

| é—®é¢˜ | å†³ç­– | ä¾æ® |
|------|------|------|
| æ ¸å¿ƒæ¦‚å¿µæœ‰å¤šå°‘ï¼Ÿ | **æç®€**ï¼šåŸå­èŠ‚ç‚¹ + State èŠ‚ç‚¹ + Delay è¾¹ | æ¶æ„ä¸€è‡´æ€§ |
| éœ€è¦ç¡¬ç¼–ç  RNN/LSTM å—ï¼Ÿ | **ä¸éœ€è¦**ï¼šä½œä¸ºå¯é€‰æ¨¡æ¿å±‚æä¾› | Hybrid æ–¹æ¡ˆ |
| hidden state å¦‚ä½•ç®¡ç†ï¼Ÿ | **é»˜è®¤éšå¼**ï¼šå¯é€‰æ˜¾å¼æ¥å£ | å¼€æºé¡¹ç›®å…±è¯† |
| NEAT å’Œæ¢¯åº¦è®­ç»ƒå…¼å®¹å—ï¼Ÿ | **å…¼å®¹**ï¼šNEAT æœç´¢ç»“æ„ + æ¢¯åº¦å¾®è°ƒæƒé‡ | EXAMM éªŒè¯ |
| ä¼˜å…ˆå®ç°å“ªä¸ªè®°å¿†å•å…ƒï¼Ÿ | **âˆ†-RNN**ï¼ˆæ€§ä»·æ¯”æœ€é«˜ï¼‰ | EXAMM è®ºæ–‡ |
| å¾ªç¯è¿æ¥çš„æ­£ç¡®æŠ½è±¡ï¼Ÿ | **Delay(k) è¾¹**ï¼šè·¨æ—¶é—´æ­¥çš„è¿æ¥ | æ¶æ„æ–‡æ¡£ |
| BPTT åº”åœ¨å“ªå±‚å®ç°ï¼Ÿ | **æ‰§è¡Œå¼•æ“å±‚** | äº”å±‚æ¶æ„ |

---

*æœ¬æ–‡æ¡£è®°å½•äº† only_torch è®°å¿†æœºåˆ¶çš„è®¾è®¡å†³ç­–ï¼Œç»¼åˆäº† NEAT/EXAMM è®ºæ–‡æ´å¯ŸåŠå¤šä¸ªå¼€æºé¡¹ç›®çš„å®ç°ç»éªŒã€‚*

*æœ€åæ›´æ–°ï¼š2024-12-29ï¼ˆPhase 2 å®Œæˆï¼›æ–°å¢å˜é•¿åºåˆ— Padding+Mask æ–¹æ¡ˆæ–‡æ¡£ï¼‰*
