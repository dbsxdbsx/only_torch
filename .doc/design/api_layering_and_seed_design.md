# API åˆ†å±‚ä¸ç§å­ç®¡ç†è®¾è®¡

> åˆ›å»ºæ—¥æœŸ: 2025-12-21
> çŠ¶æ€: **å·²å®ç°** (Graph çº§åˆ«ç§å­å·²å®Œæˆ)
> å…³è”: [architecture_roadmap.md](../architecture_roadmap.md), [optimizer_architecture_design.md](./optimizer_architecture_design.md)

## 1. èƒŒæ™¯ä¸åŠ¨æœº

### 1.1 é—®é¢˜é™ˆè¿°

éšç€é¡¹ç›®å‘å±•ï¼Œæˆ‘ä»¬éœ€è¦å›ç­”ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š**å¦‚ä½•è®¾è®¡ API å±‚æ¬¡ï¼Œä½¿å…¶æ—¢å¯¹æ–°ç”¨æˆ·å‹å¥½ï¼Œåˆä¸ºé«˜çº§ç”¨æˆ·å’Œ NEAT è¿›åŒ–ç®—æ³•ä¿ç•™çµæ´»æ€§ï¼Ÿ**

ç§å­ç®¡ç†ï¼ˆSeed Managementï¼‰æ˜¯è¿™ä¸ªé—®é¢˜çš„ä¸€ä¸ªå…¸å‹åˆ‡å…¥ç‚¹ï¼š
- æµ‹è¯•éœ€è¦å¯é‡å¤æ€§
- ç”¨æˆ·å¸Œæœ›ç®€å•è®¾ç½®ä¸€æ¬¡
- NEAT éœ€è¦å¤šå›¾å¹¶è¡Œç‹¬ç«‹è¿è¡Œ

### 1.2 æ¶æ„çº¦æŸï¼ˆæ¥è‡ª NEAT éœ€æ±‚ï¼‰

```
âš ï¸ æ ¸å¿ƒçº¦æŸï¼šé¿å…å…¨å±€çŠ¶æ€
   åŸå› ï¼šNEAT ç®—æ³•å¯èƒ½åŒæ—¶è¿›åŒ–å¤šä¸ª Graph å®ä¾‹
```

è¿™æ„å‘³ç€ PyTorch é£æ ¼çš„ `torch.manual_seed()` å…¨å±€ç§å­æ–¹æ¡ˆ**ä¸é€‚ç”¨**ã€‚

---

## 2. API åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  High-Level API (è¿œæœŸ)                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  â€¢ nn::Sequential, nn::Module é£æ ¼                          â”‚
â”‚  â€¢ è‡ªåŠ¨ç®¡ç†ç§å­ã€è®¾å¤‡ã€æ¨¡å¼                                    â”‚
â”‚  â€¢ ç›®æ ‡ç”¨æˆ·ï¼šå¿«é€ŸåŸå‹ã€æ•™å­¦                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Graph-Level API (ä¸­æœŸç›®æ ‡) â† æ¨èçš„é»˜è®¤å±‚                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â€¢ Graph::new_with_seed(seed) / graph.set_seed(seed)        â”‚
â”‚  â€¢ æ¯ä¸ª Graph ç‹¬ç«‹ RNG çŠ¶æ€                                  â”‚
â”‚  â€¢ ç›®æ ‡ç”¨æˆ·ï¼šæ ‡å‡†è®­ç»ƒæµç¨‹ã€NEAT                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Granular API (å½“å‰) â† åº•å±‚å·¥å…·                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  â€¢ Tensor::normal_seeded(), shuffle_mut_seeded()            â”‚
â”‚  â€¢ new_parameter_node_seeded()                              â”‚
â”‚  â€¢ æ˜¾å¼æ§åˆ¶æ¯ä¸ªéšæœºæ“ä½œ                                       â”‚
â”‚  â€¢ ç›®æ ‡ç”¨æˆ·ï¼šå•å…ƒæµ‹è¯•ã€åº“å¼€å‘è€…ã€ç²¾ç¡®è°ƒè¯•                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.1 å„å±‚èŒè´£

| å±‚çº§ | ç§å­ç®¡ç† | é€‚ç”¨åœºæ™¯ | çŠ¶æ€ |
|-----|---------|---------|------|
| Granular | `fn_seeded(..., seed)` | å•å…ƒæµ‹è¯•ã€ç²¾ç¡®æ§åˆ¶ | âœ… å·²å®ç° |
| Graph-Level | `Graph::new_with_seed(seed)` / `Graph::set_seed(seed)` | è®­ç»ƒè„šæœ¬ã€NEAT | âœ… å·²å®ç° |
| High-Level | è‡ªåŠ¨/é…ç½®åŒ– | å¿«é€ŸåŸå‹ | ğŸ“‹ è¿œæœŸ |

---

## 3. Graph çº§åˆ«ç§å­è®¾è®¡ï¼ˆä¸­æœŸç›®æ ‡ï¼‰

### 3.1 è®¾è®¡æ–¹æ¡ˆ

```rust
// æ–¹æ¡ˆ Aï¼šæ„é€ æ—¶è®¾ç½®ï¼ˆæ¨èï¼‰
let graph = Graph::new();           // éšæœºç§å­ï¼ˆéç¡®å®šæ€§ï¼‰
let graph = Graph::new_with_seed(42); // å›ºå®šç§å­ï¼ˆç¡®å®šæ€§ï¼‰

// æ–¹æ¡ˆ Bï¼šè¿è¡Œæ—¶è®¾ç½®
let mut graph = Graph::new();
graph.set_seed(42);  // é‡ç½® RNG çŠ¶æ€

// å†…éƒ¨å®ç°
pub struct Graph {
    // ... existing fields ...
    rng: Option<StdRng>,  // None = ä½¿ç”¨ thread_rng()
}
```

### 3.2 å½±å“èŒƒå›´

å½“ Graph æœ‰ç§å­æ—¶ï¼Œä»¥ä¸‹æ“ä½œä½¿ç”¨ Graph çš„ RNGï¼š
- `new_parameter_node()` - å‚æ•°åˆå§‹åŒ–
- æœªæ¥å¯èƒ½ï¼šDropoutã€æ•°æ®å¢å¼ºç­‰

### 3.3 ä¸ Granular API çš„å…³ç³»

```rust
// Granular API ä»ç„¶å¯ç”¨ï¼Œä¼˜å…ˆçº§æ›´é«˜
let graph = Graph::new_with_seed(42);

// ä½¿ç”¨ Graph çš„ RNG
let w = graph.new_parameter_node(&[3, 1], Some("w"))?;

// æ˜¾å¼è¦†ç›–ï¼Œä½¿ç”¨æŒ‡å®šç§å­ï¼ˆGranular APIï¼‰
let b = graph.new_parameter_node_seeded(&[1, 1], Some("b"), 999)?;
```

### 3.4 NEAT å…¼å®¹æ€§éªŒè¯

```rust
// å¤šä¸ª Graph å¹¶è¡Œè¿›åŒ–ï¼Œäº’ä¸å¹²æ‰°
let graphs: Vec<Graph> = (0..100)
    .map(|i| Graph::new_with_seed(i as u64))
    .collect();

// æ¯ä¸ª graph ç‹¬ç«‹åˆå§‹åŒ–ï¼Œç»“æœå¯é‡å¤
for graph in &mut graphs {
    let param = graph.new_parameter_node(&[10, 10], None)?;
    // ç›¸åŒç§å­çš„ graph äº§ç”Ÿç›¸åŒçš„å‚æ•°å€¼
}
```

---

## 4. å®ç°è·¯å¾„

### é˜¶æ®µ 1ï¼šå½“å‰çŠ¶æ€ âœ…
- Granular API (`_seeded` æ–¹æ³•) å·²å®ç°
- é›†æˆæµ‹è¯•ä½¿ç”¨æ˜¾å¼ç§å­ï¼Œç»“æœå¯é‡å¤

### é˜¶æ®µ 2ï¼šGraph çº§åˆ«ç§å­ âœ… (2025-12-21 å®Œæˆ)
- [x] ä¸º `Graph` æ·»åŠ  `rng: Option<StdRng>` å­—æ®µ
- [x] å®ç° `Graph::new_with_seed(seed)`
- [x] å®ç° `Graph::set_seed(seed)`
- [x] å®ç° `Graph::with_name_and_seed(name, seed)`
- [x] å®ç° `Graph::has_seed()` æ£€æŸ¥æ–¹æ³•
- [x] ä¿®æ”¹ `new_parameter_node()` ä½¿ç”¨ Graph çš„ RNGï¼ˆå¦‚æœ‰ï¼‰
- [x] 8 ä¸ªå•å…ƒæµ‹è¯•éªŒè¯åŠŸèƒ½
- [ ] æ›´æ–°é›†æˆæµ‹è¯•ä½¿ç”¨ Graph çº§åˆ«ç§å­ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

### é˜¶æ®µ 3ï¼šHigh-Level APIï¼ˆè¿œæœŸï¼‰
- åœ¨ `nn::Module` æˆ–ç±»ä¼¼æŠ½è±¡ä¸­è‡ªåŠ¨å¤„ç†ç§å­
- å¯èƒ½æä¾›é…ç½®æ–‡ä»¶/ç¯å¢ƒå˜é‡æ–¹å¼è®¾ç½®

---

## 5. è®¾è®¡å†³ç­–è®°å½•

| å†³ç­– | é€‰æ‹© | åŸå›  |
|-----|------|------|
| å…¨å±€ç§å­ vs Graph ç§å­ | Graph ç§å­ | NEAT éœ€è¦å¤šå›¾å¹¶è¡Œ |
| é»˜è®¤è¡Œä¸ºï¼ˆæ— ç§å­ï¼‰ | éç¡®å®šæ€§ | ç¬¦åˆç”¨æˆ·é¢„æœŸï¼Œç”Ÿäº§ç¯å¢ƒå¸¸æ€ |
| Granular API ä¿ç•™ | æ˜¯ | æµ‹è¯•éœ€è¦ã€å‘åå…¼å®¹ |
| RNG ç±»å‹ | `StdRng` | è·¨å¹³å°ä¸€è‡´ã€å¯åºåˆ—åŒ– |

---

## 6. å¼€æ”¾é—®é¢˜

1. **ç§å­æ˜¯å¦éœ€è¦åºåˆ—åŒ–ï¼Ÿ** - NEAT ä¿å­˜/åŠ è½½è¿›åŒ–çŠ¶æ€æ—¶å¯èƒ½éœ€è¦
2. **æ˜¯å¦æ”¯æŒ `Graph::fork()`ï¼Ÿ** - ä»å½“å‰ RNG çŠ¶æ€åˆ†å‰ï¼Œç”¨äºè¿›åŒ–åˆ†æ”¯
3. **Tensor å±‚é¢æ˜¯å¦ä¹Ÿéœ€è¦ RNG ä¸Šä¸‹æ–‡ï¼Ÿ** - ç›®å‰ `Tensor::normal()` ç‹¬ç«‹äº Graph

---

## 7. å‚è€ƒ

- PyTorch: `torch.manual_seed()`, `torch.Generator`
- JAX: æ˜¾å¼ PRNGKey ä¼ é€’ï¼ˆå‡½æ•°å¼é£æ ¼ï¼‰
- TensorFlow: `tf.random.set_seed()` + `tf.random.Generator`

